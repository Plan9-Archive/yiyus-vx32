#!/bin/sh

# Most of the kernel and library files come in virtually unchanged.
# Rather than maintain the few changes by hand, we keep a set
# of ed scripts that we can run on the originals to produce 
# the versions we need.
#
# This directory also contains a few files that aren't 
# autogenerated, but are extracted from elsewhere and 
# would distract from vxplan9 itself if placed in the main
# directory (utf.[ch], fmt.[ch], latin1.h, arg.h).

autofiles="
/386/include/ureg.h
/sys/include/a.out.h
/sys/include/authsrv.h
/sys/include/cursor.h
/sys/include/draw.h
/sys/include/fcall.h
/sys/include/ip.h
/sys/include/keyboard.h
/sys/include/libsec.h
/sys/include/memdraw.h
/sys/include/memlayer.h
/sys/include/mouse.h
/sys/include/tos.h
/sys/include/trace.h
/sys/src/9/pc/dat.h
/sys/src/9/pc/devether.c
/sys/src/9/pc/errstr.h
/sys/src/9/pc/etherif.h
/sys/src/9/pc/fns.h
/sys/src/9/pc/io.h
/sys/src/9/pc/mem.h
/sys/src/9/pc/sdscsi.c
/sys/src/9/port/allocb.c
/sys/src/9/port/aoe.h
/sys/src/9/port/auth.c
/sys/src/9/port/chan.c
/sys/src/9/port/dev.c
/sys/src/9/port/devaoe.c
/sys/src/9/port/devcap.c
/sys/src/9/port/devcons.c
/sys/src/9/port/devdraw.c
/sys/src/9/port/devdup.c
/sys/src/9/port/devenv.c
/sys/src/9/port/devmnt.c
/sys/src/9/port/devpipe.c
/sys/src/9/port/devproc.c
/sys/src/9/port/devroot.c
/sys/src/9/port/devsd.c
/sys/src/9/port/devssl.c
/sys/src/9/port/devsrv.c
/sys/src/9/port/devtls.c
/sys/src/9/port/error.h
/sys/src/9/port/fault.c
/sys/src/9/port/latin1.c
/sys/src/9/port/lib.h
/sys/src/9/port/netif.c
/sys/src/9/port/netif.h
/sys/src/9/port/page.c
/sys/src/9/port/parse.c
/sys/src/9/port/pgrp.c
/sys/src/9/port/portdat.h
/sys/src/9/port/portfns.h
/sys/src/9/port/print.c
/sys/src/9/port/proc.c
/sys/src/9/port/qio.c
/sys/src/9/port/qlock.c
/sys/src/9/port/sd.h
/sys/src/9/port/sdaoe.c
/sys/src/9/port/segment.c
/sys/src/9/port/swap.c
/sys/src/9/port/sysfile.c
/sys/src/9/port/sysproc.c
/sys/src/9/port/systab.h
/sys/src/9/port/thwack.c
/sys/src/9/port/thwack.h
/sys/src/libc/port/u16.c
/sys/src/libc/port/u32.c
/sys/src/9/port/unthwack.c
/sys/src/boot/pc/fs.h
/sys/src/boot/pc/dosfs.h
/sys/src/boot/pc/kfs.h
/sys/src/boot/pc/part.c
/sys/src/libc/9syscall/sys.h
/sys/src/libc/9sys/convD2M.c
/sys/src/libc/9sys/convM2D.c
/sys/src/libc/9sys/convM2S.c
/sys/src/libc/9sys/convS2M.c
/sys/src/libc/9sys/fcallfmt.c
/sys/src/libc/port/cleanname.c
/sys/src/libc/port/encodefmt.c
/sys/src/libc/port/getfields.c
/sys/src/libc/port/strecpy.c
/sys/src/libc/port/tokenize.c
/sys/src/libc/port/u64.c
/sys/src/libip/bo.c
/sys/src/libip/classmask.c
/sys/src/libip/eipfmt.c
/sys/src/libip/ipaux.c
/sys/src/libip/parseip.c
"

plan9=$HOME/plan9
if [ $# -gt 1 ] && [ $1 == "-r" ]; then
	plan9=$2
	shift 2
fi

if [ ! -d $plan9/sys/src ]; then
	echo "$0 error: $plan9/sys/src is not a directory" 1>&2
	exit 1
fi

case "$#" in
0)
	;;
*)
	autofiles="$*"
esac

for f in $autofiles
do
	test -f $plan9/$f  || echo "$0 error: $plan9/$f not found" 1>&2
	ed=`echo $f | sed 's;.*/;;; s;\.[ch]$;;; s;$;.ed;'`
	test -f $ed || ed=`echo $f | sed 's;.*/;;; s;$;.ed;'`
	out=`echo $f | sed 's;.*/;;;'`
	echo -n $f '->' $out
	test -f $ed && echo ' ('$ed')' || echo
	test -f $out && chmod +w $out
	(
		echo ',s;"../port/;";g'
		echo ',s;#include.*<;#include ";g'
		echo ',s;#include.*>;&FIXINCLUDEME;g'
		echo ',s;>FIXINCLUDEME;";g'
		echo ',s;"libc.h";"lib.h";g'
		echo ',s;SET(\(.*\));;g'
		echo 'g/#pragma/d'
		test -f $ed && cat $ed
		echo w $out
		echo q
	) | ed -s $plan9/$f 2>&1 | egrep -v '^[0-9?]+$'
done

exit 0